# מדריך הרשאות - SafeQ Cloud Manager

## תוכן עניינים
1. [סקירה כללית](#סקירה-כללית)
2. [רמות הרשאה](#רמות-הרשאה)
3. [דרישות להתחברות מוצלחת](#דרישות-להתחברות-מוצלחת)
4. [הגדרת קבוצות ב-Entra ID](#הגדרת-קבוצות-ב-entra-id)
5. [תהליך אימות והרשאות](#תהליך-אימות-והרשאות)
6. [שאלות ותשובות](#שאלות-ותשובות)

---

## סקירה כללית

מערכת SafeQ Cloud Manager משתמשת במודל הרשאות היברידי המשלב:
- **אימות דרך Microsoft Entra ID (Azure AD)** - זיהוי המשתמש וקביעת רמת ההרשאה
- **אימות מול SafeQ Cloud** - אישור קיום משתמש לוקאלי תואם
- **הרשאות מחלקתיות** - הגבלת גישה למחלקות/בתי ספר ספציפיים

---

## רמות הרשאה

המערכת תומכת ב-**4 רמות הרשאה**, המוגדרות דרך קבוצות ב-Entra ID:

### 1️⃣ SafeQ-View (צופה)
**הרשאות:**
- ✅ צפייה במשתמשים במחלקות המורשות
- ✅ צפייה בקבוצות במחלקות המורשות
- ❌ ללא אפשרות עריכה, יצירה או מחיקה

**מתאים ל:**
- צפייה ודיווח בלבד
- צוות שאינו מבצע שינויים במערכת

---

### 2️⃣ SafeQ-Support (תמיכה)
**הרשאות:**
- ✅ כל הרשאות Viewer
- ✅ עריכת משתמשים קיימים במחלקות המורשות
- ✅ הוספה והסרה של משתמשים מקבוצות
- ✅ יצירת משתמשים חדשים (במחלקות המורשות בלבד)
- ❌ ללא אפשרות מחיקת משתמשים

**מתאים ל:**
- צוות תמיכה טכנית
- מנהלי IT ברמת מחלקה/בית ספר

---

### 3️⃣ SafeQ-Admin (מנהל)
**הרשאות:**
- ✅ כל הרשאות Support
- ✅ מחיקת משתמשים במחלקות המורשות
- ✅ ניהול מלא של משתמשים וקבוצות
- ✅ פעולות Bulk (פעולות קבוצתיות)
- ⚠️ הרשאות מוגבלות למחלקות המוגדרות עבור המשתמש

**מתאים ל:**
- מנהלי IT ראשיים
- מנהלי מחלקות עם הרשאות מלאות

---

### 4️⃣ SafeQ-SuperAdmin (מנהל על)
**הרשאות:**
- ✅ **גישה בלתי מוגבלת לכל המערכת**
- ✅ צפייה ועריכה של **כל המשתמשים והקבוצות** (כולל "Local Users")
- ✅ פעולות Bulk על כל המחלקות
- ✅ ניהול מלא ללא הגבלות מחלקתיות

**מתאים ל:**
- צוות IT ארגוני
- מנהלי מערכת ראשיים

---

## דרישות להתחברות מוצלחת

כדי להתחבר בהצלחה למערכת, המשתמש **חייב לעמוד בכל** התנאים הבאים:

### ✅ דרישה 1: שייכות לקבוצת Entra ID
המשתמש חייב להיות שייך **לאחת לפחות** מהקבוצות הבאות ב-Microsoft Entra ID:
- `SafeQ-View`
- `SafeQ-Support`
- `SafeQ-Admin`
- `SafeQ-SuperAdmin`

**אם המשתמש לא שייך לאף קבוצה** - הגישה תידחה עם הודעת שגיאה:
> "גישה נדחתה. נדרשת שייכות לקבוצת SafeQ."

---

### ✅ דרישה 2: קיום משתמש לוקאלי תואם ב-SafeQ Cloud
המשתמש חייב שיהיה קיים **משתמש לוקאלי במערכת SafeQ Cloud** עם אותו שם משתמש (UserPrincipalName).

**דוגמה:**
- שם משתמש ב-Entra: `cohen_m@example.com`
- שם משתמש נדרש ב-SafeQ: `cohen_m@example.com`

**אם המשתמש לא קיים במערכת SafeQ** - הגישה תידחה עם הודעה:
> "לא נמצא משתמש לוקאלי תואם במערכת SafeQ. אנא פנה לספק המערכת לצורך בירור נוסף."

---

### ✅ דרישה 3: שייכות למחלקה (רק עבור Viewer/Support/Admin)
משתמשים ברמות **Viewer, Support ו-Admin** חייבים להיות משויכים **לקבוצה של מחלקה/בית ספר** במערכת SafeQ.

**פורמט שמות קבוצות:** `<שם מחלקה> - <מספר>`
**דוגמאות:**
- `צפת - 240234`
- `עלי זהב - 234768`
- `רמת גן - 309874`

**אם המשתמש לא משויך לאף קבוצת מחלקה** - הגישה תידחה עם הודעה:
> "לא נמצאו הרשאות מחלקה עבור משתמש זה. המשתמש לא משויך לאף בית ספר. אנא פנה לספק המערכת."

**⚠️ חריגה:** משתמשי **SuperAdmin** אינם זקוקים לשייכות מחלקתית - יש להם גישה לכל המחלקות.

---

## הגדרת קבוצות ב-Entra ID

### שלב 1: יצירת קבוצות הרשאה
ב-Microsoft Entra ID Admin Center, צור **4 Security Groups**:

```
שם קבוצה          תיאור
─────────────────  ──────────────────────────────────────
SafeQ-View         הרשאות צפייה במערכת SafeQ Cloud Manager
SafeQ-Support      הרשאות תמיכה ועריכה במערכת
SafeQ-Admin        הרשאות ניהול מלא במחלקות ספציפיות
SafeQ-SuperAdmin   הרשאות מנהל על - גישה לכל המערכת
```

### שלב 2: הוספת משתמשים לקבוצות
הוסף כל משתמש **לקבוצה אחת** בלבד (הקבוצה עם רמת ההרשאה הגבוהה ביותר שנדרשת עבורו).

**דוגמה:**
- `user1@example.com` → הוסף ל-`SafeQ-View`
- `user2@example.com` → הוסף ל-`SafeQ-Support`
- `admin@example.com` → הוסף ל-`SafeQ-SuperAdmin`

---

## תהליך אימות והרשאות

כאשר משתמש מתחבר, המערכת מבצעת את התהליך הבא:

```
┌─────────────────────────────────────┐
│  1. אימות מול Entra ID              │
│  ✓ משתמש מזוהה ומאומת               │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  2. בדיקת שייכות לקבוצת SafeQ      │
│  ✓ בדיקה: שייך לאחת מ-4 הקבוצות?   │
│  ✗ לא → סירוב גישה                  │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  3. קביעת רמת הרשאה (Role)          │
│  ✓ View / Support / Admin / SuperAdmin │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  4. חיפוש משתמש לוקאלי ב-SafeQ     │
│  ✓ בדיקה: קיים משתמש תואם?          │
│  ✗ לא → סירוב גישה                  │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  5. טעינת קבוצות לוקאליות          │
│  ✓ קבלת רשימת קבוצות של המשתמש     │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  6. חילוץ הרשאות מחלקתיות           │
│  ✓ SuperAdmin → "ALL"                │
│  ✓ אחרים → רשימת מחלקות מהקבוצות    │
│  ✗ אין מחלקות (ולא SuperAdmin) →    │
│     סירוב גישה                       │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  ✅ התחברות מוצלחת!                 │
│  המשתמש מקבל גישה למערכת            │
└─────────────────────────────────────┘
```

---

## שאלות ותשובות

### ❓ מה קורה אם משתמש לא שייך לאף קבוצת SafeQ?
**תשובה:** המשתמש לא יוכל להתחבר ויראה הודעת שגיאה:
> "גישה נדחתה. נדרשת שייכות לקבוצת SafeQ."

---

### ❓ האם משתמש יכול להיות שייך למספר קבוצות SafeQ?
**תשובה:** כן, אבל המערכת תבחר את רמת ההרשאה **הגבוהה ביותר** לפי סדר העדיפות:
1. SuperAdmin (הכי גבוה)
2. Admin
3. Support
4. View (הכי נמוך)

**דוגמה:** משתמש ב-`SafeQ-View` וגם ב-`SafeQ-Admin` יקבל הרשאות `Admin`.

---

### ❓ האם SuperAdmin צריך להיות משויך למחלקה?
**תשובה:** לא! SuperAdmin מקבל אוטומטית גישה לכל המחלקות במערכת.

---

### ❓ מה קורה אם המשתמש הלוקאלי ב-SafeQ לא קיים?
**תשובה:** המשתמש לא יוכל להתחבר. יש ליצור משתמש לוקאלי ב-SafeQ Cloud עם אותו UserPrincipalName.

---

### ❓ איך אני יודע למה משתמש לא הצליח להתחבר?
**תשובה:** המערכת מציגה הודעות שגיאה ברורות:
1. **אין קבוצת SafeQ** → "גישה נדחתה. נדרשת שייכות לקבוצת SafeQ."
2. **אין משתמש לוקאלי** → "לא נמצא משתמש לוקאלי תואם במערכת SafeQ..."
3. **אין מחלקה** → "לא נמצאו הרשאות מחלקה עבור משתמש זה..."

כל השגיאות נרשמות גם ב-Audit Log לצורך מעקב.

---

### ❓ איך מוסיפים משתמש חדש למערכת?
**תשובה:** תהליך הוספת משתמש חדש:
1. ✅ צור משתמש ב-Microsoft Entra ID
2. ✅ הוסף אותו לקבוצת SafeQ מתאימה (`SafeQ-View/Support/Admin/SuperAdmin`)
3. ✅ צור משתמש תואם ב-SafeQ Cloud (עם אותו UserPrincipalName)
4. ✅ שייך את המשתמש לקבוצת מחלקה ב-SafeQ (אם אינו SuperAdmin)
5. ✅ המשתמש יכול להתחבר למערכת!

---

### ❓ איך משנים רמת הרשאה למשתמש קיים?
**תשובה:**
1. הסר את המשתמש מקבוצת SafeQ הנוכחית ב-Entra ID
2. הוסף אותו לקבוצת SafeQ החדשה
3. המשתמש יקבל את ההרשאות החדשות בכניסה הבאה

---

## סיכום מהיר

| רמת הרשאה      | דרישת קבוצה ב-Entra | דרישת משתמש לוקאלי | דרישת שייכות מחלקה | גישה למחלקות                  |
|----------------|---------------------|---------------------|-------------------|-------------------------------|
| **View**       | ✅ SafeQ-View       | ✅ כן                | ✅ כן              | רק מחלקות משויכות              |
| **Support**    | ✅ SafeQ-Support    | ✅ כן                | ✅ כן              | רק מחלקות משויכות              |
| **Admin**      | ✅ SafeQ-Admin      | ✅ כן                | ✅ כן              | רק מחלקות משויכות              |
| **SuperAdmin** | ✅ SafeQ-SuperAdmin | ✅ כן                | ❌ לא              | **כל המחלקות (ALL)**          |

---

**מסמך זה עודכן לאחרונה:** 2025-10-30
**גרסת מערכת:** 2.0 (Hybrid Authentication Model)

---

**צריך עזרה נוספת?**
צור קשר עם צוות התמיכה או פנה למנהל המערכת שלך.
